- binary_sensor:
    unique_id: espresso_machine_is_hot
    name: "Espresso machine is hot"
    delay_on: 00:10:00
    delay_off: 00:10:00
    state: "{{ is_state('sensor.espresso_machine_state', 'standby') }}"

- binary_sensor:
    unique_id: espresso_machine_is_stale
    name: "Espresso machine is stale"
    delay_on: 00:40:00
    state: "{{ is_state('sensor.espresso_machine_state', 'standby') }}"

- sensor:
    unique_id: espresso_machine_state
    name: "Unica state"
    state: >
      {% set avg = states('sensor.unica_power_average10') | float %}
      {% if is_state('switch.lumi_lumi_plug_mmeu01_on_off', 'off') %}
        off
      {% elif avg > 350 %}
        heating
      {% elif avg > 0 %}
        standby
      {% else %}
        failure
      {% endif %}
