- binary_sensor:
  - unique_id: espresso_machine_is_hot
    name: "Espresso machine is hot"
    delay_on: 00:20:00
    delay_off: 00:00:10
    state: "{{ is_state('switch.lumi_lumi_plug_mmeu01_on_off', 'on') }}"

- binary_sensor:
  - unique_id: espresso_machine_is_stale
    name: "Espresso machine is stale"
    delay_on: 00:40:00
    state: "{{ is_state('switch.lumi_lumi_plug_mmeu01_on_off', 'on') }}"

- sensor:
  - unique_id: espresso_machine_state
    name: "Espresso machine state: heating, standby, off or failure"
    state: >
      {% set sma = states('sensor.unica_power_sma20') | float %}
      {% if is_state('switch.lumi_lumi_plug_mmeu01_on_off', 'off') %}
        off
      {% elif sma < 100 %}
        failure
      {% elif sma < 300 %}
        standby
      {% else %}
        heating
      {% endif %}
